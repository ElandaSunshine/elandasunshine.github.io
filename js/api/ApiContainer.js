import handlebars from"https://cdn.jsdelivr.net/npm/handlebars@4.7.8/+esm";import md5 from"https://cdn.jsdelivr.net/npm/md5@2.3.0/+esm";import RequestApi from"/js/api/RequestApi.js";export default class ApiContainer extends HTMLElement{url;cacheId;cacheTime;requestHeaders;requestParams;requestFilters;#e;#t=null;#r;#i=!1;#s;constructor(){super(),this.style.setProperty("display","block");const api_url=this.getAttribute("api")?.trim(),cache_time=this.getAttribute("cache")?.trim(),cache_id=this.getAttribute("name")?.trim(),headers=this.getAttribute("headers")?.trim(),params=this.getAttribute("params")?.trim(),filters=this.getAttribute("filters")?.trim(),mode=this.getAttribute("mode")?.trim(),template=this.getAttribute("template")?.trim();if(headers&&eval(`this.requestHeaders = {${headers}}`),params&&eval(`this.requestParams = {${params}}`),filters&&(this.requestFilters=filters.split(",")),mode)switch(mode){case"auto":this.#i=!1;break;case"manual":this.#i=!0;break;default:return void(this.#t=`Invalid execution mode '${mode}'`)}template&&(this.#r={promise:fetch(template)});try{this.url=new URL(api_url)}catch(e){return void(this.#t=`Invalid API url ${api_url}`)}if(""!==api_url){try{this.cacheTime=Number.parseInt(cache_time??"0")}catch(e){return void(this.#t=`Invalid cache time ${cache_time}`)}this.cacheId=cache_id,this.#e=new RequestApi({apiUrl:this.url.href,cacheKey:this.cacheId,cacheTime:this.cacheTime})}else this.#t=`Invalid API url '${api_url}'`}connectedCallback(){this.#t||this.#i||this.updateContents()}get error(){return this.#t}updateContents({callback:e,endpoint:t,append:r=!1,onlyIfDifferent:i=!0,hbs_init:s,onlyIfCached:a,params:n}){if(!this.#t)try{const h=JSON.parse(JSON.stringify(this.requestParams??{}));n&&Object.entries(n).forEach((([e,t])=>{null!=t&&(h[e]=t)}));this.#e.request({endpoint:t,filter:this.requestFilters?{keys:this.requestFilters}:void 0,params:h,headers:this.requestHeaders,onlyIfCached:a}).then((t=>{const a=(e,t)=>{try{this.#s=md5(JSON.stringify(t))}catch(e){this.#s=md5(String(t))}this.dispatchEvent(new CustomEvent("requestdone",{bubbles:!0,cancelable:!1,detail:{content:e,processed:t}}))},n=(()=>{if(e){const r=e(t);if(void 0!==r)return r}return t})();if(i&&this.#s){if((()=>{try{return md5(JSON.stringify(n))}catch(e){return md5(String(n))}})()===this.#s)return void this.dispatchEvent(new CustomEvent("requestdone",{bubbles:!0,cancelable:!1}))}if(null==n)return this.innerHTML="",void a(t,n);if(this.#r){const e=e=>{this.innerHTML=(r?this.innerHTML:"")+e(n)};this.#r.template?(e(this.#r.template),a(t,n)):this.#r.promise.then((async r=>{const i=await r.text();this.#r.template||(s&&s(handlebars),this.#r.template=handlebars.compile(i)),e(this.#r.template),a(t,n)}),(e=>{this.#t=e,this.dispatchEvent(new CustomEvent("requestdone",{bubbles:!0,cancelable:!1,detail:{error:e}}))}))}else{const e=(()=>{try{return JSON.stringify(n)}catch(e){return n}})();this.innerHTML=`<p>${e}</p>`,a(t,n)}}),(e=>{this.#t=e,this.dispatchEvent(new CustomEvent("requestdone",{bubbles:!0,cancelable:!1,detail:{error:e}}))}))}catch(e){this.#t=e,this.dispatchEvent(new CustomEvent("requestdone",{bubbles:!0,cancelable:!1,detail:{error:e}}))}}}customElements.define("api-con",ApiContainer);
