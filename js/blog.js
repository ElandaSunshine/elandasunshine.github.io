import"/js/api/ApiContainer";import"/js/base";import $ from"https://cdn.jsdelivr.net/npm/jquery@3.7.1/+esm";import moment from"https://cdn.jsdelivr.net/npm/moment@2.29.4/+esm";import clamp from"https://cdn.jsdelivr.net/npm/clamp-js@0.7.0/+esm";const max_init_posts=9,categories={};let currentPosts=[],currentScrollId=null;function setupPostTemplate(t){if(!t)return null;const e=[];for(const r of t.posts??[]){if(e.length===max_init_posts)break;currentPosts.some((t=>t.ID===r.ID))||(r.excerpt=r.excerpt.replaceAll(/(<([^>]+)>)/gi,""),e.push(r))}const r=currentPosts.length;return currentPosts.push(...e),$("#show-more-posts").toggleClass("disabled",!(currentPosts.length<t.found)),$("#posts-total")[0].innerText=`Showing ${currentPosts.length} of ${t.found+r}`,e}function determineScrollButtonDisplay(t){if(!(t.scrollWidth>t.clientWidth))return;const e=t.scrollWidth-t.offsetWidth;$("#btt-scroll-left").css("display",0===t.scrollLeft?"none":"revert"),$("#btt-scroll-right").css("display",t.scrollLeft===e?"none":"revert")}function getSelectedCategories(){const t=Object.entries(categories).filter((([,t])=>t)).map((([t])=>t));return t.length?t.join(","):null}async function setupCategories(t){const e=t.get("category")?.split(",")??[],r=await fetch(new URL("categories",$("#posts")[0].url+"/"),{searchParams:new URLSearchParams({number:1e3,fields:"name,slug"})}),s=await r.json(),n=$("#cat-list"),o=s.categories;if(o?.length){for(let t=0;t<o.length;++t){const r=o[t],s=r.name,l=r.slug;if(categories.hasOwnProperty(l))continue;const c=e.includes(l)||e.includes(s);categories[l]=c,$(`\n                <span class="cat-entry">\n                    <input id="cat-${t}"\n                           type="checkbox"\n                           value="${l}"\n                           ${c?"checked":""}>\n                    <label for="cat-${t}">${s}<label>\n                <span>\n            `).appendTo(n)}$("span.cat-entry input[type=checkbox]").on("change",(t=>{const e=t.currentTarget,r=e.value;categories[r]=e.checked,currentPosts=[],$("#posts")[0].updateContents({endpoint:"posts/",callback:setupPostTemplate,params:{category:getSelectedCategories()}})}))}}function scrollFull(t,e){const r=t.getBoundingClientRect(),s=(()=>{const t=document.elementsFromPoint(r.x+20,r.y);for(const r of t){const t=$(r);if(t.hasClass("cat-entry"))return e?20===Math.trunc(t.position().left)?t.prev("span.cat-entry"):t:t.next("span.cat-entry")}const s=document.elementsFromPoint(r.x+31,r.y);for(const t of s){const r=$(t);if(r.hasClass("cat-entry"))return e?r.prev("span.cat-entry"):r}return null})();null!=s&&t.scroll({left:s.position().left+(t.scrollLeft-20),behavior:"instant"})}function doScrollActionHelper(t,e,r){if(t.shiftKey)e.scroll({left:r?0:e.scrollWidth-e.offsetWidth,behavior:"smooth"});else{if(resetScrollInterval(),t.ctrlKey)return scrollFull(e,r),currentScrollId=0,void setTimeout((()=>{0===currentScrollId?currentScrollId=setInterval((t=>{(r?0!==Math.trunc(t.scrollLeft):t.scrollLeft!==t.scrollLeft-t.offsetWidth)?scrollFull(t,r):resetScrollInterval()}),200,e):resetScrollInterval()}),500);currentScrollId=setInterval((t=>{(r?0!==Math.trunc(t.scrollLeft):t.scrollLeft!==t.scrollLeft-t.offsetWidth)?t.scrollBy(r?-10:10,0):resetScrollInterval()}),25,e)}}function resetScrollInterval(){null!=currentScrollId&&(clearInterval(currentScrollId),currentScrollId=null)}$((()=>{$.event.special.touchstart={setup:function(t,e,r){this.addEventListener("touchstart",r,{passive:!e.includes("noPreventDefault")})}},$.event.special.touchmove={setup:function(t,e,r){this.addEventListener("touchmove",r,{passive:!e.includes("noPreventDefault")})}},$("#cat-list").on("scroll",(t=>{determineScrollButtonDisplay(t.currentTarget)})),$("#cat-list").on("wheel",(t=>{t.preventDefault(),t.currentTarget.scroll({left:t.currentTarget.scrollLeft+(t.shiftKey?t.originalEvent.deltaY/10:t.originalEvent.deltaY)})})),$("button.cat-scroller").on("mousedown touchstart",(t=>{const e=$("#cat-list")[0];$(t.currentTarget).hasClass("left-scroll")?doScrollActionHelper(t,e,!0):doScrollActionHelper(t,e,!1)})),$("button.cat-scroller").on("touchend",resetScrollInterval),$(document).on("mouseup",resetScrollInterval);const t=$("#posts");if($("#show-more-posts").on("click",(e=>{$(e.target).hasClass("disabled")||t[0].updateContents({endpoint:"posts/",callback:setupPostTemplate,append:!0,params:{category:getSelectedCategories(),before:currentPosts.length?currentPosts[currentPosts.length-1].date:null}})})),t[0].error){$(t[0]).removeClass("loading");const e=$("#posts-error")[0];e.textContent="Error loading latest posts",e.style.display="revert"}else t.on("requestdone",(t=>{if($(t.target).removeClass("loading"),!t.detail)return;const e=$("#posts-error")[0];if(t.detail?.error)return console.debug(t.detail.error),e.innerText="Error loading latest posts",void(e.style.display="revert");if(!t.detail?.processed?.length)return e.innerText="No posts found",void(e.style.display="revert");e.style.display="none",$("#cat-nav-container").css("display","revert"),$("#show-more-posts").css("display","table"),$("article",t.target).on("click",(t=>{window.open(new URL("blog/"+t.currentTarget.dataset.postId,window.location.href),"_self")}));const r=$("article.blog-article > div.blog-main");if(r.length>0)for(const t of r)clamp($("h2",t)[0],{clamp:4}),clamp($("p.description",t)[0],{clamp:5})}));const e=new URLSearchParams(window.location.search);setupCategories(e).then((()=>setTimeout((()=>{const t=$("#cat-list"),e=$("#cat-list span.cat-entry input:checked");if(e.length){const r=window.matchMedia("screen and (max-width: 600px)").matches?0:-20;t.animate({scrollLeft:e[0].parentNode.offsetLeft+r},500)}determineScrollButtonDisplay(t[0])}),100))),t[0].updateContents({endpoint:"posts/",callback:setupPostTemplate,params:{category:e.get("category")},hbs_init:t=>{t.registerHelper("getMoment",(t=>moment(new Date(t)).fromNow())),t.registerHelper("getCategory",(t=>Object.values(t)[0].name))}})}));
